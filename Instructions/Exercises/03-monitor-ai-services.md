---
lab:
  title: 監視 Azure AI 服務
  module: Module 2 - Developing AI Apps with Azure AI Services
---

# 監視 Azure AI 服務

Azure AI 服務可以是整體應用程式基礎結構的關鍵部分。 務必能夠監視活動，並收到可能需要留意之問題的警示。

## 在 Visual Studio Code 中，複製您的存放庫

您將使用 Visual Studio Code 開發您的程式碼。 您應用程式的程式碼檔案已在 GitHub 存放庫中提供。

> **秘訣**：如果您已複製 **mslearn-ai-language** 存放庫，請在 Visual Studio 程式碼中開啟它。 否則，請遵循下列步驟將其複製到您的開發環境。

1. 啟動 Visual Studio Code。
2. 開啟選擇區 (SHIFT+CTRL+P) 並執行 **Git：複製 ** 命令，將 `https://github.com/MicrosoftLearning/mslearn-ai-services` 存放庫複製到本機資料夾 (哪個資料夾無關緊要)。
3. 複製存放庫後，請在 Visual Studio Code 中開啟此資料夾。
4. 等候其他檔案安裝以在需要時支援存放庫中的 C# 程式碼專案

    > **注意**：如果系統提示您新增必要的資產來組建和偵錯，請選取 [現在不要]****。

5. 展開 `Labfiles/03-monitor-ai-services` 資料夾。

## 佈建 Azure AI 服務資源

如果您的訂用帳戶中還沒有 **Azure AI 服務**資源，則必須加以佈建。

1. 開啟 Azure 入口網站 (位於 `https://portal.azure.com`)，使用與您的 Azure 訂用帳戶相關聯的 Microsoft 帳戶進行登入。
2. 在頂端搜尋列中，搜尋 *Azure AI 服務*、選取 [Azure AI 服務]****，並使用下列設定建立 Azure AI 服務多服務帳戶資源：
    - **訂用帳戶**：您的 Azure 訂用帳戶**
    - **資源群組**：*選擇或建立資源群組 (如果您使用受限制的訂用帳戶，則您可能沒有建立新資源群組的權限 - 請使用所提供的資源群組)*
    - **區域**：*選擇任何可用的區域*
    - **名稱**：輸入唯一名稱**
    - **定價層**:標準 S0
3. 選取任何必要的核取方塊並建立資源。
4. 等候部署完成，然後檢視部署的詳細資料。
5. 部署資源後，請移至該資源並檢視其 [金鑰和端點] **** 頁面。 記下端點 URI - 您稍後會用到。

## 設定警示

讓我們藉由定義警示規則來開始監視，以便偵測 Azure AI 服務資源中的活動。

1. 在Azure 入口網站中，移至您的 Azure AI 服務資源，並檢視其 [警示]**** 頁面 (位於 [監視]**** 區段中)。
2. 選取 [+ 建立]**** 下拉式清單，然後選取 [警示規則]****
3. 在 [建立警示規則]**** 頁面的 [範圍]**** 之下，確認您的 Azure AI 服務資源已列出。 (關閉 [選取訊號]**** 窗格 (如果已開啟))
4. 選取 [條件]**** 索引標籤，然後選取 [查看所有訊號]**** 連結，以顯示右側顯示的 [選取訊號]**** 窗格，而您可以在其中選取要監視的訊號類型。
5. 在 [訊號類型]**** 列表中，向下捲動至 [活動記錄]**** 區段，然後選取 [列出金鑰 (認知服務 API 帳戶)]****。 接著選取**套用**。
6. 檢閱過去 6 小時內的活動。
7. 選取 [動作]**** 索引標籤。請注意，您可以指定*動作群組*。 這可讓您在引發警示時設定自動化動作，例如傳送電子郵件通知。 在此練習中，我們不會這麼做；但是在生產環境中這麼做可能很有用。
8. 在 [詳細資料]**** 索引標籤中，將 [警示規則名稱]**** 設定為 [金鑰清單警示]****。
9. 選取 [**檢閱 + 建立**]。 
10. 檢閱警示的設定。 選取 [建立]****，然後等候警示規則建立。
11. 現在，您可使用下列命令來取得 Azure AI 服務金鑰清單、將 *&lt;resourceName&gt;* 取代為您的 Azure AI 服務資源名稱，並將 *&lt;resourceGroup&gt;* 取代為您在其中建立的資源群組名稱。

    ```
    az cognitiveservices account keys list --name <resourceName> --resource-group <resourceGroup>
    ```

    此命令會傳回 Azure AI 服務資源的金鑰清單。

    > **注意** 如果您尚未登入 Azure CLI，您可能需要先執行 `az login`，列出金鑰命令才能正常運作。

12. 切換回包含 Azure 入口網站的瀏覽器，然後重新整理您的 [警示] 頁面****。 您應會看到列在資料表中的 **Sev 4** 警示 (如果沒有，請等候多達五分鐘，然後再次重新整理)。
13. 選取警示以查看其詳細資料。

## 將計量視覺化

除了定義警示，您還可以檢視 Azure AI 服務資源的計量，以監視其使用率。

1. 在 Azure 入口網站中，於 Azure AI 服務資源的頁面中，選取 [計量]**** (位於 [監視]**** 區段中)。
2. 如果沒有現有的圖表，請選取 [+ 新增圖表]****。 然後在 [計量]**** 清單中，檢閱您可以視覺化的可能計量，然後選取 [呼叫總數]****。
3. 在 [彙總]**** 清單中，選取 [計數]****。  這可讓您監視對您 Azure AI 服務資源的呼叫總數，有助於判斷在一段時間內使用的服務數量。
4. 若要對 Azure AI 服務產生一些要求，您將使用 **curl** - 適用於 HTTP 要求的命令列工具。 在編輯器中，開啟 **rest-test.cmd** 並編輯其中包含的 **curl** 命令 (如下所示)，將 *&lt;yourEndpoint&gt;* 和 *&lt;yourKey&gt;* 取代為您的端點 URI 和 **Key1** 金鑰，以在 Azure AI 服務資源中使用文字分析 API。

    ```
    curl -X POST "<your-endpoint>/language/:analyze-text?api-version=2023-04-01" -H "Content-Type: application/json" -H "Ocp-Apim-Subscription-Key: <your-key>" --data-ascii "{'analysisInput':{'documents':[{'id':1,'text':'hello'}]}, 'kind': 'LanguageDetection'}"
    ```

5. 儲存變更，然後執行下列命令：

    ```
    ./rest-test.cmd
    ```

    此命令會傳回 JSON 文件，其中包含在輸入資料中偵測到的語言相關資訊 (應該是英文)。

6. 重新執行 **rest-test** 命令多次，以產生一些呼叫活動 (您可以使用 **^** 金鑰來逐一查看先前的命令)。
7. 返回 Azure 入口網站中的 [計量]**** 頁面，然後重新整理 [呼叫總數]**** 計數圖表。 使用 *curl* 進行的呼叫可能需要幾分鐘的時間才會反映在圖表中- 請持續重新整理圖表，直到更新成包含這些呼叫為止。

## 清除資源

如果您不將本實驗中所建立的 Azure 資源用於其他訓練模組，則可以將其刪除以避免產生進一步的費用。

1. 開啟 Azure 入口網站 (位於 `https://portal.azure.com`)，然後在頂端搜尋列中搜尋您在此實驗中所建立的資源。

2. 在資源頁面上，選取 [刪除]**** 並依照指示刪除該資源。 或者，您也可以刪除整個資源群組以同時清理所有資源。

## 其他相關資訊

監視 Azure AI 服務的其中一個選項是使用*診斷記錄*。 啟用後，診斷記錄會擷取有關 Azure AI 服務資源使用量的豐富資訊，並可成為實用的監視和偵錯工具。 在設定診斷記錄之後，可能需要一小時以上的時間才能產生任何資訊，這就是我們在此練習中尚未探索其原因；但您可以在 [Azure AI 服務文件](https://docs.microsoft.com/azure/ai-services/diagnostic-logging)中深入了解。
